OPEN_BT	EQU	P3.0
DOOR	EQU	P3.1
ALARM	EQU	P3.6
UNLOCK	EQU	P3.7

;States encoding proposal
ST_BT	EQU	0
ST_UNL	EQU	1
ST_OP	EQU	2
ST_AL	EQU	3

BSEG	AT	0
TICK:	DBIT	1

DSEG	AT	30H
;Door controller state 
DC_STATE:	DS	1

;Test variables - do not modify
TEST_TMR:	DS	1


CSEG AT 0H
RESET:
	AJMP	INIT_SYSTEM
	;Interrupt vectors - ISR entries
ORG 0003H
	AJMP	INT0_ISR
ORG 000BH
	AJMP	T0_ISR
ORG 0013H
	AJMP	INT1_ISR
ORG 001BH
	AJMP	T1_ISR
ORG 0023H
	AJMP	UART_ISR
ORG 002BH
	AJMP	T2_ISR

INIT_SYSTEM:
	MOV		SP,#7Fh
	CLR		TICK	
	;Initialization timer T0 to trigger every 64 cycles
	;Using autoreload from TH0 no adjustment necessary in T0_ISR
	MOV		TH0,#192
	MOV		TL0,#192
	MOV		IE,#82H
	MOV		TMOD,#02H
	MOV		TCON,#10H
	
	
TEST:	
	MOV		TEST_TMR,#20
	ACALL	TEST_WAIT	
	JNB		UNLOCK,TEST_ERR
	JNB		ALARM,TEST_ERR
	
	CLR		OPEN_BT
	MOV		TEST_TMR,#3
	ACALL	TEST_WAIT
	JB		UNLOCK,TEST_ERR
	JNB		ALARM,TEST_ERR
	
	SETB	OPEN_BT
	MOV		TEST_TMR,#3
	ACALL	TEST_WAIT
	JB		UNLOCK,TEST_ERR
	JNB		ALARM,TEST_ERR
	
	CLR		DOOR
	MOV		TEST_TMR,#70
	ACALL	TEST_WAIT
	JNB		UNLOCK,TEST_ERR	
	JB		ALARM,TEST_ERR
	
	SETB	DOOR
	MOV		TEST_TMR,#3
	ACALL	TEST_WAIT
	JNB		UNLOCK,TEST_ERR
	JNB		ALARM,TEST_ERR	
	
TEST_DONE:
	SJMP	TEST_DONE
	
TEST_ERR:
	SJMP	TEST_ERR
	
TEST_WAIT:
	JNB		TICK,$
	CLR		TICK
	DJNZ	TEST_TMR,TEST_WAIT
	RET
	
	
T0_ISR:
	PUSH	PSW
	PUSH	ACC
	SETB	TICK
T0_ISR_BODY:
	; Here goes your code	
	JB		OPEN_BT,CHECK_DOOR
	MOV 	R0,#10
	CLR 	UNLOCK
CHECK_DOOR:
	JNB		DOOR,CHECK0
	MOV 	R1,#60
	SETB 	ALARM
CHECK0:
	DJNZ 	R0,CHECK1
	SETB 	UNLOCK
CHECK1:
	DJNZ 	R1,END_CHECK
	CLR 	ALARM
END_CHECK:
T0_ISR_EX:			
	POP		ACC
	POP		PSW
T0_ISR_DONE:	
	RETI	
	
T1_ISR:		
INT0_ISR:
INT1_ISR:
UART_ISR:
T2_ISR:
	RETI
	
	END
	


	


