PWM_PERIOD	EQU	16
PWM_OUT		EQU	P1.0
TH0_INIT	EQU	254

DSEG		AT	30H
DUTY:		DS	1
PWM_CNT:	DS	1
PWM_DUTY:	DS	1

BSEG	AT	0H	
PWM_SYNC:	DBIT	1

CSEG AT 0H
RESET:
	AJMP	INIT_SYSTEM
	;Interrupt vectors - ISR entries
ORG 0003H
	AJMP	INT0_ISR
ORG 000BH
	AJMP	T0_ISR
ORG 0013H
	AJMP	INT1_ISR
ORG 001BH
	AJMP	T1_ISR
ORG 0023H
	AJMP	UART_ISR
ORG 002BH
	AJMP	T2_ISR



INIT_SYSTEM:
	MOV		SP,#7Fh
	CLR		PWM_OUT
	MOV		TH0,#TH0_INIT
	MOV		TMOD,#0
	MOV		TCON,#10H
	MOV		IE,#82H	
	MOV		DUTY,#0
	MOV		PWM_CNT,#15

; This code is a test unit that increase PWM duty 
; every two periods notified by PWM_SYNC bit
TEST_LOOP:
	MOV		R7,#2
TEST_REP:	
	JNB		PWM_SYNC,$
	CLR		PWM_SYNC
	DJNZ	R7, TEST_REP	
	INC		DUTY
	MOV		A,DUTY
	CJNE	A,#16,TEST_LOOP	
TEST_DONE:
	SJMP	$	
	
T0_ISR:
	PUSH	PSW
	PUSH	ACC
T0_ISR_BODY:
	MOV		TH0,#TH0_INIT
	; Your code goes here
	MOV 	A,#PWM_PERIOD
	SUBB 	A,DUTY
	MOV 	R0,A
	MOV 	R1,DUTY
	INC		R1
	INC		R0
	SETB	PWM_SYNC
	SETB	PWM_OUT
LP_ON:
	DJNZ 	R1,LP_ON
	CLR 	PWM_OUT
LP_OFF:
	DJNZ 	R0,LP_OFF
T0_ISR_EX:			
	POP		ACC
	POP		PSW
T0_ISR_DONE:	
	RETI	
	
T1_ISR:		
INT0_ISR:
INT1_ISR:
UART_ISR:
T2_ISR:
	RETI
	
	END

	
