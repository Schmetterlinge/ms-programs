define int last_light
define int clk_cnt


signal void clkGen()
{	
	for(;;)
	{		
		twatch(20);
		P3 = P3 ^ 0x01;
		++clk_cnt;
		printf("clk counter (clk*2: %d \n",clk_cnt);
	
		

	}
}

func void onLight()
{	
int light;
	light = P3 & 0x80;
	if(light != last_light)
	{
		if(light){
			
			printf("@%d: Light: ON\n", states);
		clk_cnt=0;
		}
		else
			printf("@%d: Light: OFF\n", states);
				clk_cnt=0;
	}
	last_light = light;
}

func void onButton()
{	
int button1;
	button1 = P1;
	if(button1 != last_button)
	{
		if(button1){
			
			printf("@%d: Button: ON \n", states);

		}
		else
			printf("@%d: Button: OFF \n", states);
	}
	last_button = button1;
}
signal void MainTB(){
	twatch(60);//startup
	P3=P3&~(0x02);//daylight sensor off
	P1=0x01;
	twatch(20);
	P1=0x00;//momentary push of a button,light on and off after 20 clk cycles
	twatch(400);
	for(;;){
		twatch(1);
		if(clk_cnt==8)break;
	}
	P1=0x01;
	twatch(20);
	P1=0x00;//momentary push of a button,light on and off after 6 clk cycles because of another button push
	twatch(20);
		for(;;){
		twatch(1);
		if(clk_cnt==12){
			P1=0x01;
		twatch(50);
		P1=0x00;
			break;
		}
	}
			for(;;){//waiting 4 cycles
		twatch(1);
		if(clk_cnt==8)break;
	}
		P1=0x01;
	twatch(20);
	P1=0x00;//momentary push of a button,light on and off after 20 clk cycles, button push after 3 clck cycles
	twatch(30);
		for(;;){
		twatch(1);
		if(clk_cnt==6){
			P1=0x01;
		twatch(20);
		P1=0x00;
			break;
		}
	}
	
	
	
}

BK	*
BS WRITE P3, 1, "onLight()"
BS WRITE P1, 1, "onButton()"
last_light = P3 & 0x80
P1=0x00;
clkGen()

MainTB()